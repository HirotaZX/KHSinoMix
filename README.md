
# 王国之心 SINO MIX - 汉化逆向研究计划

王国之心 FINAL MIX 系列的汉化逆向研究计划，主要工作是以 PC 英文国际版为基础，研究以下几个方面：

1. 逆向出游戏文本数据的编码和组织方式，从而可以从游戏数据文件中导出文本，用于翻译工作
2. 逆向游戏字库和码表文件，从而可以将其替换为中文汉字字库
3. 逆向游戏字库和字体渲染处理程序，突破其原先的字库读取大小限制，让汉化文本可以使用更多的汉字，并且保证字体正常渲染
4. 开发文本导出导入、汉字去重分析、码表和字库文件自动生成等的辅助工具


## UK SYS 菜单 UI 字库
### 0x00 ~ 0x14 控制符区

`0x00`: EOL，结束本块文本

`0x01`: 空格

`0x02`: 换行

`0x03`|`0x00`: 换行并以参数为本块后续行高

`0x04`: 本块下一行左对齐到本块起始位置

`0x05`: 本块下一行右对齐到本块起始位置

`0x06`: 本块下一行中心对齐到本块起始位置

`0x07`|`0x00`: 设置本块后续文字颜色，0~255对应不同颜色（应该有颜色表？）

`0x08`|`0x00000000`: 设置本块后续文字颜色，顺序为RGBA

`0x09`: 设置本块后续文字颜色为某种颜色 **<暂定>**

`0x0A`: 可能是预设文本、变量或者指针，目前发现的为 `Goofy`，可能导致**崩溃**

`0x0B`|`0x000000`: 根据参数渲染替换文本，可能导致**崩溃**

`0x0C`|`0x00`: 本块后续每个字以参数为宽度进行缩放，参数为无符号数

`0x0D`|`0x0000`: 本行后续文本沿 `X` 轴偏移，参数为小端有符号数

`0x0E`|`0x0000`: 本块后续文本沿 `Y` 轴偏移，参数为小端有符号数

`0x0F`|`0x00`: 显示特殊/按键图标

<details>
<summary>图标详情表</summary>

|值|图标|
|-|-|
|`0x00`|`OK` 按钮|
|`0x01`|警告图标 **<暂定>**|
|`0x02`|彩色药水图标|
|`-`|连续映射，一系列彩色小图标|
|`0x1C`|红色圆形|
|`0x41`|手柄 `A` / 鼠标左键|
|`0x41`|手柄 `A` / 鼠标左键|
|`0x42`|手柄 `B` / 键盘空格|
|`0x43`|手柄 `B` / 键盘空格|
|`0x44`|手柄 `A` / 鼠标左键|
|`0x45`|手柄 `X` / 鼠标右键|
|`0x46`|手柄 `Y` / 键盘 `F`|
|`0x47`|手柄 `LB` / 键盘 `Shift`|
|`0x48`|手柄 `RB` / 键盘 `R`|
|`0x49`|手柄 `LT` / 键盘 `C`|
|`0x4A`|手柄 `RT` / 键盘 `E`|
|`0x4B`|手柄左摇杆按下 / 键盘 `X`|
|`0x4C`|手柄右摇杆按下 / 鼠标中键|
|`0x4D`|手柄 `SELECT` / 键盘 `N`|
|`0x4E`|手柄 `START` / 键盘 `M`|
|`0x4F`|手柄左摇杆 / 键盘 `WASD`|
|`0x50`|手柄右摇杆 / 鼠标滑动|
|`0x51`|手柄摇杆 / 手柄 `B`|
|`0x52`|手柄方向键 / 键盘方向键|
|`0x53`|手柄方向键上下 / 键盘方向键上下|
|`0x54`|手柄方向键左右 / 键盘方向键左右|
|`0x55`|手柄方向键上 / 键盘方向键上|
|`0x56`|手柄方向键下 / 键盘方向键下|
|`0x57`|手柄方向键左 / 键盘方向键左|
|`0x58`|手柄方向键右 / 键盘方向键右|
|`0x59`|手柄左摇杆上 / 键盘 `W`|
|`0x5A`|手柄左摇杆下 / 键盘 `S`|
|`0x5B`|手柄左摇杆左 / 键盘 `A`|
|`0x5C`|手柄左摇杆右 / 键盘 `D`|
|`0x5D`|手柄右摇杆上 / 鼠标上滑|
|`0x5E`|手柄右摇杆下 / 鼠标下滑|
|`0x5F`|手柄右摇杆左 / 鼠标左滑|
|`0x60`|手柄右摇杆右 / 鼠标右滑|

</details>
<br>

`0x10`:  EOL，结束本块文本 **<暂定>**

`0x11`|`0x0000`: 设置本块后续文本相对**画布**左边界的 `X` 轴坐标，参数为小端有符号数

`0x12`|`0x0000`: 设置本块后续文本相对**画布**上边界的 `Y` 轴坐标，参数为小端有符号数

`0x13`|`0x0000`: 设置本块后续文本相对**局部**左边界的 `X` 轴坐标，参数为小端有符号数

`0x14`|`0x0000`: 设置本块后续文本相对**局部**上边界的 `Y` 轴坐标，参数为小端有符号数

### 0x15 ~ 0x1F 扩展字库查找区

扩展字库的 **通用查找** 方式为：

1. 将控制符和参数连起来作为 2 字节数（如 `0x19`|`0x2A` -> `0x192A`）
2. 计算与 `0x1820` 的偏移值，此偏移值为字符序号
> 小于 `0x1820` 的数，由于偏移是负数可能没有意义

`0x15`|`0x00`: 扩展字库通用查找

`0x16`|`0x00`: 扩展字库通用查找

`0x17`|`0x00`: 扩展字库通用查找

`0x18`|`0x00`: 将参数里的字节左移 8 位（如 `0x19` -> `0x1900`），计算与 `0x1820` 的偏移值，此偏移值为字符序号

> 小于等于 `0x18` 的参数，由于偏移是负数可能没有意义

> 大于 `0x1F` 的参数，由于已不属于扩展字库范围，意义也不大

`0x19`|`0x00`: 扩展字库通用查找（sysfont.bin）

<details>
<summary>字符详情表</summary>

|值|字符|
|-|-|
|`0x38`|字库第 3 块第 1 位|
|`-`|连续映射|
|`0xC3`|字库第 3 块最后 1 位|
|`0xC4`|字库第 4 块第 1 位|
|`-`|连续映射|
|`0xD8`|字库第 4 块第 2 行第 7 列|
|`0xD9`|字库第 1 块第 1 行第 12 列 （默认为`A`）|
|`-`|连续映射|
|`0xFF`|字库第 1 块第 4 行第 8 列（默认为`m`）|

</details>
<br>

`0x1A`|`0x00`: 扩展字库通用查找（sysfont.bin）

<details>
<summary>字符详情表</summary>

|值|字符|
|-|-|
|`0x00`|字库第 1 块第 4 行第 9 列（默认为`n`）|
|`-`|连续映射|
|`0x0E`|字库第 1 块第 5 行第 9 列（默认为`?`）|


</details>
<br>

`0x1B`|`0x00`: 扩展字库通用查找

`0x1C`|`0x00`: 扩展字库通用查找

`0x1D`|`0x00`: 扩展字库通用查找

`0x1E`|`0x00`: 扩展字库通用查找

`0x1F`|`0x00`: 扩展字库通用查找

> 综上可以看出，扩展字库的容量为 `0x19`|`0x00` ~ `0x1F`|`0xFF`，不考虑字库调用限制的情况下，逻辑上最大可以表示 `1792`（`0x700`） 个不同字符

### 0x20 ~ 0xFC 基础字库查找区

`0x20`~`0xFC`: 基础字库查找（sysfont.bin），查找方式为计算与 `0x20` 的偏移值，此偏移值为字符序号

> 注意：字符序号与字库图片不一定是顺序或连续的对应关系

<details>
<summary>字符详情表</summary>

|值|字符|
|-|-|
|`0x20`|字库第 1 块第 1 位（默认为 `——`）|
|`-`|连续映射|
|`0xA9`|字库第 1 块倒数第 3 位（默认为 `®`）|
|`0xAA`|字库第 2 块第 1 位（默认为空）|
|`0xC4`|字库第 2 块第 2 行第 11 列（默认为 `罗马数字III`）|
|`-`|连续映射|
|`0xFC`|字库第 2 块第 6 行第 11 列（默认为 `《`）|

</details>
<br>


## UK EVT 剧情对话字库

字库存在 `UK_kanji.knj` 目录下的 dds 文件

文本的宽度信息存在 `UK_kanji.knj` 二进制文件的末尾，开头为 `18 0D 0A 0D`

码表： ？？？

字库选字方式：？？？

## 备忘

### 字库目前的限制

1. 字符编码逻辑上最大可以表示 `2016`（`0x20~0xFF, 0x1900~0x1FFF`） 个不同字符

2. 位图读取逻辑（EVT字库）

- 英文版最大可以摆放 `1344`（`21 * 16 * 4`）个不同字符

- 日文版最大可以摆放 `1764`（`21 * 21 * 4`）个不同字符

3. 存储字宽的数组上限为 `3968`

### 如果想要扩容，需要修改：

1. 修改编码逻辑
- 比如用 `0x18 0x20 0x??` 三字节来表示一个汉字，一个控制符字节 + 双字节最大可以表示 `65535` 个汉字

> 但是代码中疑似对大于 `9999` 序号的字符有特殊处理，有可能无法超出该范围

2. 修改字库位图读取逻辑
- 每行 21 个字， 宽度 24 像素，是写死的，还涉及到字符宽度控制表，不好修改，高度和行数有全局变量可以修改，最好还是用日语的高 24 像素方块字，每列 21 个字

- 处理 4 块区域是写死的，每个区域 `行 * 列` 个字，也不好修改，但最好的方式就是能让区域无限扩大，比如 2048x2048 的 4 块区域字库，扩展成 4096x4096 的 16 块区域字库，难度有些大

3. 修改字宽表，在 `UK_kanji.knj` 文件的末尾，修改字宽表数组的长度

### 目前想到的方案

> 列出的地址都是相对的，仅供参考

EVT 字库
- 字宽数组长度难以修改，先不考虑
- 编码逻辑也不好改
- 可以字节 Patch 修改字体读取高度，最终可以扩到 `21 x 24 x 4 =  2016` 个字符（不修改宽度，不超过编码上限）
    - `0x14018d18f`: 设置空格宽度指令
    - `0x14018d192`: 设置最大字符数指令
    - `0x14018d197`: 设置字体高度指令
    - `0x14018d19a`: 设置字体行数指令
    - `0x14018d1c8`: 设置行高指令 1 （普通）
    - `0x14018d1d2`: 设置行高指令 2 （稀疏）
- 字宽表，在 `UK_kanji.knj` 文件的末尾
- `UK_kanji_knj0.dds` 字库位图

SYS 字库需要修改：
- `0x1402E99B7` 码表长度常量，默认 `560 (0x230)`，修改为 `2016 (0x7E0)`
  - ！！码表读取到内存后，超出 `1025` 的部分，会被后面的数据覆盖，编码 `1C19`~`1F6A` 之间的渲染出问题
  - ~~A 方案：将码表位每行字节精简？16 字节数据去掉与渲染无关的后 8 字节，代码所有用到的地方改为以 8 字节为单位读取~~
    - `0x14052A700` [10]: 存储指向数字 0~9 的指针
    - `0x14052A6F0`: 存储指向字母 B （非日版）或者 ➖ （日版）的指针
    - `0x142E16BF0`: 码表起始地址
    - ...读取的地方太多，难以完全修改

  - > 最终选取 B 方案，难度稍高，但是相对容易维护

  - **B 方案：改为动态分配内存，需要调整指令，替换所有引用**
    - `0x1402D15B0` 改为 `jmp` 到分配内存代码，后补 `nop`（会影响 ida 分析，分析时可以改成 call，最终补丁用 jmp）
    - 在空闲区域编写调用内存分配函数（`0x14028DCF0`）分配内存（`0x1403ADED8`有 200 字节空闲）的指令，分配 `2048 * 16` 字节内存，地址存入 `rbx`，`jmp` 回 `0x1402D15B0` 后一个指令
    - 修改几个写死的指针，`0x14052A700` 10个数字指针，`0x14052A6F0` B字符指针
    
    <details>
    <summary>参考汇编代码</summary>

    ```asm
    loc_7FF62AC8DED8:                       
                    push    rcx
                    push    rdx
                    push    rdi
                    mov     rcx, 8000h
                    call    j_malloc
                    mov     rbx, rax
                    lea     rdi, [rax+10h]
                    mov     ecx, 0Ah

    loc_7FF62AC8DEF3:                       
                    mov     rdx, rdi
                    mov     [rsi], rdx
                    add     rdi, 10h
                    add     rsi, 8
                    dec     ecx
                    jnz     short loc_7FF62AC8DEF3
                    lea     rdx, [rax+0C0h]
                    mov     cs:MY_SYS_B_PTR, rdx
                    lea     rsi, MY_SYS_NUM_PTR
                    pop     rdi
                    pop     rdx
                    pop     rcx
                    jmp     loc_7FF62ABB15B7
    ```

    </details>


- `0x1402E99AD` 字高常量，默认 `24 (0x18)`（即 48/2 ），修改为 `21 (0x15)`
- `0x1403045A2`, `0x1403045A9`, `0x1403045C5`, `0x1403045CB` 每个大块的宽高（即字库位图宽高的 1/2），默认 `4096 (0x1000)`，修改为 `8192 (0x2000)`
- `US_font_data_tbl.bin` 字库码表，每行第1、2字节为 ShiftJIS 编码值，第 3、4 字节为 X 坐标，5、6 字节为 Y 坐标，7 字节为字宽， 8 字节为所在块，9、10 字节为 Unicode 码点
- `UK_sysfont_bin0.dds` 字库位图，考虑和 EVT 字库统一